<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alerts — AI Threat Detection SOC Platform</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Animate.css for fade-ins -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #020d0a, #031510, #06261c);
            font-family: "Inter", sans-serif;
            color: white;
            overflow-x: hidden;
        }

        /* Cyber Grid Background */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-size: 45px 45px;
            background-image:
                linear-gradient(to right, rgba(0,255,130,.08) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,255,130,.08) 1px, transparent 1px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
        }
        @keyframes gridMove {
            from { transform: translateY(0); }
            to   { transform: translateY(-50px); }
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            background: rgba(0,0,0,0.45);
            border-right: 1px solid rgba(0,255,120,0.25);
            backdrop-filter: blur(12px);
            padding-top: 40px;
        }
        .sidebar h3 {
            background: linear-gradient(135deg,#00ffc3,#00c27a);
            -webkit-background-clip: text;
            color: transparent;
        }
        .sidebar a {
            display: block;
            padding: 14px 22px;
            margin: 10px 0;
            color: #b7ffdd;
            font-weight: 500;
            text-decoration: none;
            transition: 0.25s;
            border-radius: 8px;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(0,255,150,0.20);
            color: #00ffb0;
            box-shadow: 0 0 18px rgba(0,255,150,.25);
        }

        /* MAIN */
        .main {
            margin-left: 270px;
            padding: 40px 40px 70px;
        }
        .title {
            font-size: 2rem;
            font-weight: 700;
            color: #00ffb0;
        }
        .sub {
            opacity: .85;
            margin-top: -5px;
        }

        /* FILTER & ACTION BAR */
        .filter-bar {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .search-input,
        .select-filter {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(0,255,140,0.25);
            color: #ffffff;
        }
        .search-input:focus,
        .select-filter:focus {
            box-shadow: 0 0 10px #00ffb0;
            border-color: #00ffb0;
        }

        .btn-cyber {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg,#00ffb0,#00c27a);
            color: #03120c;
            font-weight: 700;
            transition: .3s;
        }
        .btn-cyber:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px #00ffb0;
        }

        .btn-lite {
            padding: 8px 14px;
            border-radius: 10px;
            font-size: .8rem;
            border: 1px solid rgba(0,255,130,.30);
            background: rgba(255,255,255,0.08);
            color: #a8ffe3;
        }
        .btn-lite:hover {
            background: rgba(0,255,130,.25);
            color: #02110c;
        }

        /* TABLE CARD */
        .table-card {
            margin-top: 25px;
            background: rgba(255,255,255,0.06);
            border-radius: 16px;
            border: 1px solid rgba(0,255,130,.22);
            backdrop-filter: blur(12px);
            padding: 18px 18px 10px;
        }
        .table thead {
            background: linear-gradient(90deg,rgba(0,255,150,0.22),rgba(0,120,80,0.25));
        }
        .table thead th {
            border: none;
            color: #e2fff5;
            text-transform: uppercase;
            font-size: .8rem;
            letter-spacing: .06rem;
        }

        /* Smooth row hover glow */
        .table-hover tbody tr {
            transition: 0.25s ease;
        }
        .table-hover tbody tr:hover {
            background: rgba(0,255,150,.06);
            transform: translateX(4px);
            box-shadow: 0 0 20px rgba(0,255,170,0.25);
            cursor: pointer;
        }

        .pill {
            font-size: .75rem;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(0,255,130,.28);
        }

        .sev-pill {
            padding: 5px 11px;
            border-radius: 999px;
            font-size: .72rem;
            font-weight: 600;
        }
        .sev-low      { background: rgba(0,180,80,0.18);  color:#56ffb0; }
        .sev-medium   { background: rgba(255,200,60,0.20);color:#ffe58c; }
        .sev-high     { background: rgba(255,120,60,0.20);color:#ffb88b; }

        /* Neon pulse for critical */
        .sev-critical {
            background: rgba(255,60,60,0.25);
            color:#ff8f8f;
            animation: neonPulse 1.5s infinite;
        }
        @keyframes neonPulse {
            0% { box-shadow: 0 0 6px #ff4b4b; }
            50% { box-shadow: 0 0 22px #ff4b4b; }
            100% { box-shadow: 0 0 6px #ff4b4b; }
        }

        .status-pill {
            padding: 5px 11px;
            border-radius: 999px;
            font-size: .72rem;
            font-weight: 600;
        }
        .st-new      { background: rgba(0,150,255,0.2);  color:#9fd3ff; }
        .st-seen     { background: rgba(170,170,170,0.18);color:#e0e0e0;}
        .st-resolved { background: rgba(0,200,120,0.20);color:#a4ffd5; }

        /* Rows fade-in (used with GSAP) */
        .fade-in-row {
            opacity: 0;
            transform: translateY(20px);
        }

        @media(max-width:768px){
            .sidebar{
                width:100%;
                height:auto;
                position:static;
                display:flex;
                flex-wrap:wrap;
                justify-content:center;
            }
            .main{
                margin-left:0;
                padding:25px 18px 60px;
            }
        }

    </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h3 class="text-center mb-4">AI SOC</h3>

    <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a href="logs.html"><i class="fas fa-file-alt"></i> Logs</a>
    <a href="incidents.html"><i class="fas fa-user-shield"></i> Incidents</a>
    <a href="alerts.html" class="active"><i class="fas fa-bell"></i> Alerts</a>
    <a href="ip-lookup.html"><i class="fas fa-globe"></i> IP Lookup</a>
    <a href="admin-users.html" class="admin-only"><i class="fas fa-users"></i> User Management</a>

    <a href="#" class="text-danger mt-2" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<!-- MAIN -->
<div class="main">
    <h2 class="title">Alert Center</h2>
    <p class="sub">High-priority notifications generated from AI-analyzed incidents (email rules & severity).</p>

    <!-- FILTER / ACTION BAR -->
    <div class="filter-bar">

        <input type="text" id="searchBox" class="form-control search-input"
               placeholder="Search message, incident, channel...">

        <select id="severityFilter" class="form-select select-filter" style="max-width:150px;">
            <option value="">All Severity</option>
            <option value="LOW">LOW</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HIGH">HIGH</option>
            <option value="CRITICAL">CRITICAL</option>
        </select>

        <select id="statusFilter" class="form-select select-filter" style="max-width:160px;">
            <option value="">All Status</option>
            <option value="NEW">NEW</option>
            <option value="SENT">SENT</option>
            <option value="SEEN">SEEN</option>
            <option value="RESOLVED">RESOLVED</option>
        </select>

        <button class="btn-lite ms-auto admin-only" id="btnMarkAllSeen">
            <i class="fas fa-eye"></i> Mark All Seen
        </button>

        <button class="btn-lite admin-only" id="btnMarkAllResolved">
            <i class="fas fa-check-circle"></i> Mark All Resolved
        </button>
    </div>

    <!-- TABLE -->
    <div class="table-card mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small" style="opacity:.8;">
                Total Alerts: <span id="countAlerts">0</span>
            </span>
            <span class="small" style="opacity:.7;">Click a row to open the related incident.</span>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Created</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Incident</th>
                        <th>Channel</th>
                        <th>Message</th>
                        <th class="admin-only">Actions</th>
                    </tr>
                </thead>
                <tbody id="alertsBody">
                    <!-- rows injected via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:8080/api";
    const token = localStorage.getItem("jwt");
    if (!token) window.location.href = "login.html";

    function logout() {
        localStorage.removeItem("jwt");
        window.location.href = "login.html";
    }

    // Role-Based UI
    (function applyRole() {
        try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            const roles = payload.roles || [];   // <- from your JWT
            if (!roles.includes("ROLE_ADMIN")) {
                document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
            }
        } catch (e) {
            console.warn("Failed to parse JWT", e);
        }
    })();

    const alertsBody = document.getElementById("alertsBody");
    const countSpan = document.getElementById("countAlerts");
    const searchBox = document.getElementById("searchBox");
    const severityFilter = document.getElementById("severityFilter");
    const statusFilter   = document.getElementById("statusFilter");

    let allAlerts = [];

    // ============================
    // LOAD ALERTS
    // ============================
    async function loadAlerts() {
        try {
            const res = await fetch(API + "/alerts", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (!res.ok) {
                alert("Failed to load alerts.");
                return;
            }

            allAlerts = await res.json();
            renderAlerts(allAlerts);

        } catch (err) {
            console.error(err);
            alert("Network error while loading alerts.");
        }
    }

    // ============================
    // RENDER ALERT TABLE (with GSAP)
    // ============================
    function renderAlerts(list) {
        alertsBody.innerHTML = "";
        countSpan.innerText = list.length;

        if (!list.length) {
            alertsBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted animate__animated animate__fadeIn">
                        No alerts generated yet.
                    </td>
                </tr>`;
            return;
        }

        list.forEach((alertObj, idx) => {
            const sev = (alertObj.severity || "LOW").toUpperCase();
            const status = (alertObj.status || "NEW").toUpperCase();
            const channel = alertObj.type || "EMAIL";
            const incidentId = alertObj.incidentId || "-";
            const msg = alertObj.message || "-";
            const created = alertObj.createdAt ? new Date(alertObj.createdAt).toLocaleString() : "-";

            let sevClass = "sev-low";
            if (sev === "MEDIUM") sevClass = "sev-medium";
            else if (sev === "HIGH") sevClass = "sev-high";
            else if (sev === "CRITICAL") sevClass = "sev-critical";

            let statusClass = "st-new";
            if (status === "SENT") statusClass = "st-seen";
            else if (status === "SEEN") statusClass = "st-seen";
            else if (status === "RESOLVED") statusClass = "st-resolved";

            const tr = document.createElement("tr");
            tr.classList.add("fade-in-row");

            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${created}</td>
                <td><span class="sev-pill ${sevClass}">${sev}</span></td>
                <td><span class="status-pill ${statusClass}">${status}</span></td>
                <td><span class="pill">#${incidentId}</span></td>
                <td><span class="pill">${channel}</span></td>
                <td style="max-width:320px;">
                    <span title="${msg.replace(/"/g, '&quot;')}">
                        ${msg.length > 60 ? msg.substring(0,60) + "...": msg}
                    </span>
                </td>
                <td class="admin-only">
                    <button class="btn-lite btn-sm me-1"
                            onclick="event.stopPropagation(); updateStatus(${alertObj.id}, 'SEEN')">
                        Seen
                    </button>
                    <button class="btn-lite btn-sm"
                            onclick="event.stopPropagation(); updateStatus(${alertObj.id}, 'RESOLVED')">
                        Resolve
                    </button>
                </td>
            `;

            // Click → pulse → go to incident
            tr.addEventListener("click", () => {
                if (incidentId && incidentId !== "-") {
                    gsap.to(tr, { scale: 0.96, duration: 0.15, yoyo: true, repeat: 1 });
                    setTimeout(() => {
                        window.location.href = "incident-details.html?id=" + incidentId;
                    }, 180);
                }
            });

            alertsBody.appendChild(tr);
        });

        // GSAP fade + stagger
        gsap.to(".fade-in-row", {
            opacity: 1,
            y: 0,
            duration: 0.6,
            stagger: 0.08,
            ease: "power2.out"
        });
    }

    // ============================
    // FILTERING
    // ============================
    function applyFilters() {
        const q = searchBox.value.toLowerCase();
        const sev = severityFilter.value;
        const st  = statusFilter.value;

        const filtered = allAlerts.filter(a => {
            const textMatch =
                (a.message || "").toLowerCase().includes(q) ||
                (a.type || "").toLowerCase().includes(q) ||
                (String(a.incidentId || "")).includes(q);

            const sevMatch = sev ? (a.severity || "").toUpperCase() === sev : true;
            const stMatch  = st ? (a.status || "").toUpperCase() === st : true;

            return textMatch && sevMatch && stMatch;
        });

        renderAlerts(filtered);
    }

    searchBox.addEventListener("input", applyFilters);
    severityFilter.addEventListener("change", applyFilters);
    statusFilter.addEventListener("change", applyFilters);

    // ============================
    // UPDATE STATUS (ADMIN ONLY)
    // ============================
    async function updateStatus(id, status) {
        try {
            const res = await fetch(API + "/alerts/" + id + "/status", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ status })
            });

            if (!res.ok) {
                alert("Failed to update status.");
                return;
            }

            await loadAlerts();

        } catch (err) {
            console.error(err);
            alert("Network error while updating status.");
        }
    }

    // ============================
    // BULK ACTIONS (ADMIN)
    // ============================
    document.getElementById("btnMarkAllSeen").addEventListener("click", async () => {
        if (!confirm("Mark ALL alerts as SEEN?")) return;

        for (const al of allAlerts) {
            const st = (al.status || "NEW").toUpperCase();
            if (st !== "SEEN" && st !== "RESOLVED") {
                await updateStatus(al.id, "SEEN");
            }
        }
    });

    document.getElementById("btnMarkAllResolved").addEventListener("click", async () => {
        if (!confirm("Mark ALL alerts as RESOLVED?")) return;

        for (const al of allAlerts) {
            const st = (al.status || "NEW").toUpperCase();
            if (st !== "RESOLVED") {
                await updateStatus(al.id, "RESOLVED");
            }
        }
    });

    // INITIAL LOAD
    loadAlerts();
</script>

</body>
</html>
