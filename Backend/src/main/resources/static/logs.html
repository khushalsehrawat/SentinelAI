<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Logs â€” AI Threat Detection Platform</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #020d0a, #031510, #06261c);
            font-family: "Inter", sans-serif;
            color: #ffffff;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-size: 45px 45px;
            background-image:
                    linear-gradient(to right, rgba(0,255,130,.08) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(0,255,130,.08) 1px, transparent 1px);
            animation: gridMove 18s linear infinite;
            z-index: -1;
        }
        @keyframes gridMove {
            from { transform: translateY(0); }
            to { transform: translateY(-50px); }
        }

        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            background: rgba(0,0,0,0.45);
            border-right: 1px solid rgba(0,255,120,0.25);
            backdrop-filter: blur(12px);
            padding-top: 40px;
        }
        .sidebar h3 {
            background: linear-gradient(135deg,#00ffc3,#00c27a);
            -webkit-background-clip: text;
            color: transparent;
        }
        .sidebar a {
            display: block;
            padding: 14px 22px;
            margin: 10px 0;
            color: #b7ffdd;
            font-weight: 500;
            text-decoration: none;
            transition: 0.3s;
            border-radius: 8px;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(0,255,150,0.18);
            color: #00ffb0;
            box-shadow: 0 0 18px rgba(0,255,150,0.25);
        }

        .main {
            margin-left: 270px;
            padding: 35px 35px 50px;
        }
        .page-title {
            font-size: 1.9rem;
            font-weight: 700;
            color: #00ffb0;
            margin-bottom: 10px;
        }
        .subtitle {
            opacity: .8;
        }

        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin: 25px 0;
        }
        .btn-cyber {
            background: linear-gradient(135deg,#00ffb0,#00c27a);
            border: none;
            color: #03120c;
            font-weight: 700;
            border-radius: 10px;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: .3s;
        }
        .btn-cyber:hover {
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 0 24px #00ffb0;
        }
        .btn-lite {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0,255,130,.3);
            background: rgba(255,255,255,0.08);
            color: #a8ffe3;
            font-size: .8rem;
        }
        .btn-lite:hover {
            background: rgba(0,255,130,.25);
            color: #02110c;
        }

        .search-input {
            max-width: 260px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0,255,140,0.25);
            color: #fff;
        }
        .search-input:focus {
            box-shadow: 0 0 10px #00ffb0;
            border-color: #00ffb0;
        }

        .table-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            border: 1px solid rgba(0,255,130,.22);
            backdrop-filter: blur(10px);
            padding: 18px 18px 8px;
        }
        .table thead {
            background: linear-gradient(90deg,rgba(0,255,150,0.22),rgba(0,120,80,0.25));
        }
        .table thead th {
            border-bottom: none;
            color: #e2fff5;
            font-size: .83rem;
            text-transform: uppercase;
            letter-spacing: .06rem;
        }
        .table tbody tr {
            border-color: rgba(255,255,255,0.05);
        }
        .table tbody tr:hover {
            background: rgba(0,255,150,0.07);
        }
        .log-text {
            max-width: 450px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: .86rem;
        }

        .badge-sev {
            border-radius: 999px;
            padding: 5px 12px;
            font-size: .72rem;
        }
        .sev-low    { background: rgba(0,180,80,0.15);  color: #50ffab; }
        .sev-medium { background: rgba(255,200,60,0.15); color: #ffd966; }
        .sev-high   { background: rgba(255,120,60,0.15); color: #ffb088; }
        .sev-critical{ background: rgba(255,60,60,0.18); color: #ff8f8f; }

        .pill-cat {
            font-size: .75rem;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(0,255,130,.35);
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #00ffb0;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            animation: spin 0.9s linear infinite;
            margin-right: 8px;
        }

        .drop-zone {
    border: 2px dashed rgba(0,255,130,0.4);
    padding: 40px;
    border-radius: 16px;
    text-align: center;
    cursor: pointer;
    background: rgba(0,255,130,0.05);
    transition: 0.3s;
}

.drop-zone:hover,
.drop-zone.drag-hover {
    background: rgba(0,255,130,0.15);
    border-color: #00ffb0;
}

.drop-icon {
    font-size: 40px;
    color: #00ffb0;
}

.glowing-box {
    border: 1px solid rgba(0,255,120,0.3);
    box-shadow: 0 0 15px rgba(0,255,130,0.15);
}

/* Smooth fade for new rows */
.fade-row {
    animation: fadeIn 0.6s ease-in;
}



/* Dropdown row styling */
.log-expand-row {
    background: rgba(0,255,120,0.05);
    backdrop-filter: blur(10px);
}

.log-expand-box {
    padding: 18px;
    border-left: 3px solid #00ffb0;
    border-right: 3px solid #00ffb0;
    border-bottom: 3px solid #00ffb0;
    background: rgba(0,255,120,0.06);
    border-radius: 0 0 14px 14px;
    animation: expandAnim 0.35s ease-out;
    color: #b8ffe4;
    font-family: "JetBrains Mono", monospace;
}

@keyframes expandAnim {
    from { opacity:0; transform:translateY(-5px); }
    to   { opacity:1; transform:translateY(0); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

        @keyframes spin {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding-bottom: 15px;
            }
            .main {
                margin-left: 0;
                padding: 20px 16px 40px;
            }
        }
    </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h3 class="text-center mb-4">AI SOC</h3>

    <a href="index.html"><i class="fas fa-house"></i> Home</a>
    <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a href="logs.html" class="active"><i class="fas fa-file-alt"></i> Logs</a>
    <a href="incidents.html"><i class="fas fa-user-shield"></i> Incidents</a>
    <a href="alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="ip-lookup.html"><i class="fas fa-globe"></i> IP Lookup</a>
    <a href="admin-users.html" class="admin-only"><i class="fas fa-users"></i> User Management</a>

    <a href="#" class="text-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>

<!-- MAIN -->
<div class="main">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div>
            <h2 class="page-title">Log Stream</h2>
            <div class="subtitle">Centralized ingestion of security events from apps, firewalls, servers, and services.</div>
        </div>
        <div class="d-none d-md-flex align-items-center">
            <div class="loader" id="globalLoader" style="display:none;"></div>
            <span id="loaderText" class="small" style="opacity:.8;"></span>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        <button class="btn-cyber" id="btnInject">
            <i class="fas fa-flask"></i> Inject Test Logs
        </button>

        <button class="btn-lite" id="btnRefresh">
            <i class="fas fa-rotate"></i> Refresh
        </button>

        <button class="btn-lite admin-only" id="btnExportJson">
            <i class="fas fa-file-code"></i> Export JSON
        </button>

        <button class="btn-lite admin-only" id="btnExportCsv">
            <i class="fas fa-file-csv"></i> Export CSV
        </button>

        <input type="text" id="searchBox" class="form-control search-input ms-auto"
               placeholder="Filter by text, source, severity...">
    </div>




    
    
    
<div class="table-card p-4 mb-4">
    <h4 class="text-light mb-3"><i class="fas fa-brain"></i> Paste Error / Console Log</h4>

    <!-- Title -->
    <input type="text" id="pasteTitle" class="form-control mb-3"
           placeholder="Short Title (e.g., React 500 Error on /login)">

    <!-- Source -->
    <input type="text" id="pasteSource" placeholder="Source (Browser, VS Code...)" 
           class="form-control mb-3">

    <!-- Category -->
    <input type="text" id="pasteCategory" class="form-control mb-3"
           placeholder="Category (Frontend Error, API Failure, etc.)">

    <textarea id="pasteArea" rows="5" class="form-control mb-3"
              placeholder="Paste browser console logs, VS Code errors, Java/Python stack trace..."></textarea>

    <button class="btn-cyber w-100" onclick="analyzePastedLog()">
        <i class="fas fa-magnifying-glass-chart"></i> Analyze Pasted Error
    </button>
</div>



<!-- ðŸ”¥ DRAG & DROP UPLOAD ZONE + TITLE + CATEGORY -->
<div class="table-card p-4 mb-4 glowing-box">
    <h4 class="text-light mb-3">
        <i class="fas fa-cloud-upload-alt"></i> Drag & Drop Log File
    </h4>

    <!-- Title -->
    <input type="text" id="logTitle" class="form-control mb-3"
           placeholder="Short Title (e.g., Java NullPointer in AuthController)">

    <!-- Source -->
    <input type="text" id="logSource" class="form-control mb-3"
           placeholder="Source (VS Code, Browser Console, Java App...)">

    <!-- Custom Category (free text) -->
    <input type="text" id="logCategory" class="form-control mb-3"
           placeholder="Category (Backend Error, Frontend Error, Build Failure...)">

    <div id="dropZone" class="drop-zone">
        <i class="fas fa-cloud-arrow-up drop-icon"></i>
        <p>Drag & Drop your log/error file here</p>
        <span class="small text-success">Or click to browse</span>
    </div>

    <input type="file" id="dragFileInput"
           accept=".txt,.log,.json,.csv,.xml,.yml,.yaml" hidden>

    <button class="btn-cyber w-100 mt-3" onclick="uploadDraggedFile()">
        <i class="fas fa-upload"></i> Analyze Uploaded File
    </button>
</div>






    <!-- Logs Table -->
    <div class="table-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small" style="opacity:.85;">Showing <span id="countLogs">0</span> logs</span>
            <span class="small" style="opacity:.7;">Click a row to view full log in console.</span>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                <tr>
                    <th>#</th>
                    <th></th>
                    <th>Timestamp</th>
                    <th>Source</th>
                    <th>Severity</th>
                    <th>Category</th>
                    <th>Log Data</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="logsBody">
                <!-- Rows injected by JS -->
                </tbody>
            </table>
        </div>
    </div>



    <!-- ðŸ§  AI Explanation Modal -->
<div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light"
         style="border-radius: 18px; border:1px solid rgba(0,255,130,.4);">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="fas fa-sparkles text-success"></i> AI Explanation
        </h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="aiModal" class="mb-0"
             style="white-space: pre-wrap; font-family: 'JetBrains Mono', monospace;"></pre>
      </div>
    </div>
  </div>
</div>



<!-- AI CHAT SIDE PANEL -->
<div id="aiChatPanel" 
     style="
        position: fixed;
        top: 0;
        right: -420px;
        width: 420px;
        height: 100%;
        background:#0c1612;
        border-left:1px solid rgba(0,255,120,0.3);
        box-shadow: -4px 0 18px rgba(0,255,150,0.2);
        transition: 0.4s;
        z-index: 9999;
        padding: 20px;
     ">
     
    <h5 class="text-info">
        <i class="fas fa-robot"></i> AI Assistant
    </h5>
    <small class="text-light" id="aiLogTitle"></small>

    <div id="aiChatOutput"
         style="height: 70%; overflow-y:auto; margin-top:15px;
                padding-right:10px; color:#e8fff4; white-space:pre-wrap;">
    </div>

    <textarea id="aiChatInput"
              class="form-control mt-3"
              placeholder="Ask something about this error.."></textarea>

    <button class="btn-cyber w-100 mt-2" onclick="sendAIChat()">
        Ask AI
    </button>

    <button class="btn btn-secondary w-100 mt-2" onclick="closeAIPanel()">
        Close
    </button>
</div>


</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:8080/api";
    const token = localStorage.getItem("jwt");


    if (!token) window.location.href = "login.html";

    function logout() {
        localStorage.removeItem("jwt");
        window.location.href = "login.html";
    }

    // ROLE-BASED: hide admin-only nav if not ADMIN
    
/* // ROLE-BASED: hide admin-only nav if not ADMIN
let roles = [];
try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    roles = payload.roles || [];
} catch (e) {
    console.error("JWT decode failed:", e);
    roles = [];
}

// hide admin-only buttons if not admin
if (!roles.includes("ROLE_ADMIN")) {
    document.querySelectorAll(".admin-only")
        .forEach(el => el.style.display = "none");
}



//let isAdmin = roles.some(r => r.authority === "ROLE_ADMIN");

let isAdmin = roles.includes("ROLE_ADMIN");


if (!isAdmin) {
    document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
}
 */

// ROLE-BASED: hide admin-only nav if not ADMIN

    (() => {

        try {

            const payload = JSON.parse(atob(token.split(".")[1]));

            const roles = payload.roles || [];

            if (!roles.includes("ROLE_ADMIN")) {

                document.querySelectorAll(".admin-only")

                    .forEach(el => el.style.display = "none");

            }

        } catch (e) {

            console.error("JWT decode failed:", e);

        }

    })();


    const loader = document.getElementById("globalLoader");
    const loaderText = document.getElementById("loaderText");

    function setLoading(isLoading, text = "") {
        loader.style.display = isLoading ? "inline-block" : "none";
        loaderText.textContent = isLoading ? text : "";
    }

    // SAMPLE LOGS
    const sampleLogs = [
        {
            logData: "Failed SSH login attempt for user 'root' from 192.168.1.50 port 22",
            source: "ubuntu-prod-01"
        },
        {
            logData: "Multiple 401 responses detected from /admin/api/auth within 30 seconds from IP 203.0.113.5",
            source: "api-gateway-1"
        },
        {
            logData: "Unusually large data transfer to external IP 198.51.100.77 over port 443 (5.3 GB)",
            source: "db-replica-02"
        },
        {
            logData: "Brute-force pattern detected: 300 login attempts against /login from IP 185.77.210.34",
            source: "auth-service"
        },
        {
            logData: "Suspicious PowerShell command execution with obfuscated base64 payload",
            source: "win-client-09"
        }
    ];

    const logsBody = document.getElementById("logsBody");
    const countLogsSpan = document.getElementById("countLogs");
    const searchBox = document.getElementById("searchBox");

    let allLogs = [];

    async function loadLogs() {
        setLoading(true, "Loading logs...");

        try {
            const res = await fetch(API + "/logs", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (!res.ok) {
                setLoading(false);
                alert("Failed to load logs.");
                return;
            }

            allLogs = await res.json();
            renderLogs(allLogs);

        } catch (e) {
            console.error(e);
            alert("Network error while loading logs.");
        }
        setLoading(false);
    }

    function renderLogs(data) {
    data = data.reverse();
    logsBody.innerHTML = "";
    countLogsSpan.textContent = data.length;

    if (!data.length) {
        logsBody.innerHTML = `
            <tr><td colspan="8" class="text-center text-muted">
                No logs found. Inject sample logs to get started.
            </td></tr>`;
        return;
    }

    data.forEach((log, idx) => {

        const sev = (log.severity || "LOW").toUpperCase();
        const cat = log.category || "General";

        let sevClass = "sev-low";
        if (sev === "MEDIUM") sevClass = "sev-medium";
        else if (sev === "HIGH") sevClass = "sev-high";
        else if (sev === "CRITICAL") sevClass = "sev-critical";

        // MAIN LOG ROW
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${log.timestamp ? new Date(log.timestamp).toLocaleString() : "-"}</td>
            <td><span class="pill-cat">${log.source || "-"}</span></td>
            <td><span class="badge-sev ${sevClass}">${sev}</span></td>
            <td><span class="pill-cat">${cat}</span></td>

            <td>
                <span class="log-text" title="${(log.title || '').replace(/"/g,'&quot;')}">
                    ${log.title || '(No Title)'}
                </span>
            </td>

            <td>
                <button class="btn btn-sm btn-warning me-1" onclick="event.stopPropagation(); explainLog(${log.id})">
                    <i class="fas fa-brain"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteLog(${log.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>

            <td>
                <i class="fas fa-caret-down text-info" style="cursor:pointer;font-size:20px;"></i>
            </td>
        `;

        // EXPANSION ROW
        const expandRow = document.createElement("tr");
        expandRow.classList.add("log-expand-row");
        expandRow.style.display = "none";

        expandRow.innerHTML = `
            <td colspan="9">
                <div class="log-expand-box">

                    <h6 class="text-success">
                        <i class="fas fa-terminal"></i> Raw Log Data
                    </h6>
                    <pre style="white-space:pre-wrap;">${log.logData || "Empty"}</pre>

                    <hr class="border-success">

                    <h6 class="text-warning"><i class="fas fa-file-alt"></i> AI Summary</h6>
                    <pre id="summary-${log.id}" class="text-light">Loading...</pre>

                    <button class="btn-cyber mt-2" onclick="event.stopPropagation(); openAIPanel(${log.id})">
                        <i class="fas fa-robot"></i> Ask AI
                    </button>
                </div>
            </td>
        `;

        // ON ROW CLICK = TOGGLE DROPDOWN
        tr.addEventListener("click", async () => {
            const currentlyOpen = expandRow.style.display === "table-row";
            expandRow.style.display = currentlyOpen ? "none" : "table-row";

            if (!currentlyOpen) {
                // Fetch AI explanation summary (lightweight)
                const res = await fetch(API + `/logs/explain/${log.id}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                const text = await res.text();
                document.getElementById(`summary-${log.id}`).textContent = text;
            }
        });

        logsBody.appendChild(tr);
        logsBody.appendChild(expandRow);
    });
}

    // FILTER
    searchBox.addEventListener("input", () => {
        const q = searchBox.value.toLowerCase();
        const filtered = allLogs.filter(log => 
        (log.logData && log.logData.toLowerCase().includes(q)) ||
        (log.source && log.source.toLowerCase().includes(q)) ||
        (log.severity && log.severity.toLowerCase().includes(q)) ||
        (log.category && log.category.toLowerCase().includes(q))
    );
        renderLogs(filtered);
    });

    // INJECT TEST LOGS
    async function injectSampleLogs() {
        if (!confirm("Inject sample logs and trigger AI analysis?")) return;

        setLoading(true, "Injecting test logs...");
        try {
            for (const log of sampleLogs) {
                await fetch(API + "/logs", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        logData: log.logData,
                        source: log.source,
    title: log.title || "Sample Log",
    category: log.category || "General"
                    })
                });
            }
            await loadLogs();
        } catch (e) {
            console.error(e);
            alert("Failed to inject sample logs.");
        }
        setLoading(false);
    }

    // EXPORT JSON
    function exportLogsJSON() {
        if (!allLogs.length) {
            alert("No logs to export.");
            return;
        }
        const blob = new Blob([JSON.stringify(allLogs, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "logs.json";
        a.click();
    }

    // EXPORT CSV
    function exportLogsCSV() {
        if (!allLogs.length) {
            alert("No logs to export.");
            return;
        }
        let csv = "id,timestamp,source,severity,category,logData\n";
        allLogs.forEach(l => {
            const row = [
                l.id,
                `"${(l.timestamp || "").toString().replace(/"/g,'""')}"`,
                `"${(l.source || "").replace(/"/g,'""')}"`,
                `"${(l.severity || "").replace(/"/g,'""')}"`,
                `"${(l.category || "").replace(/"/g,'""')}"`,
                `"${(l.logData || "").replace(/"/g,'""')}"`
            ].join(",");
            csv += row + "\n";
        });
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "logs.csv";
        a.click();
    }

    document.getElementById("btnInject").addEventListener("click", injectSampleLogs);
    document.getElementById("btnRefresh").addEventListener("click", loadLogs);
    document.getElementById("btnExportJson").addEventListener("click", exportLogsJSON);
    document.getElementById("btnExportCsv").addEventListener("click", exportLogsCSV);

    // INITIAL LOAD
    loadLogs();



    async function explainLog(id) {
    setLoading(true, "AI analyzing log...");

    try {
        const res = await fetch(API + `/logs/explain/${id}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) {
            alert("AI explanation failed.");
            setLoading(false);
            return;
        }

        const text = await res.text();

        // FIXED LINE
        document.getElementById("aiModal").textContent = text;

        // Open modal
        const modal = new bootstrap.Modal(document.getElementById("aiModal"));
        modal.show();

    } catch (e) {
        console.error(e);
        alert("Network error.");
    }

    setLoading(false);
}



    async function deleteLog(id) {
    if (!confirm("Delete this log permanently?")) return;

    try {
        const res = await fetch(API + `/logs/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (!res.ok) {
            alert("Failed to delete log.");
            return;
        }

        alert("Log deleted.");
        await loadLogs();

    } catch (e) {
        console.error(e);
        alert("Network error.");
    }
}




    async function uploadLogFile() {
    const file = document.getElementById("logFile").files[0];
    const source = document.getElementById("logSource").value.trim();
    const title = document.getElementById("logTitle").value.trim();
    const category = document.getElementById("logCategory").value.trim();

    if (!file) return alert("Select file");
    if (!title) return alert("Enter title");
    if (!source) return alert("Enter source");
    if (!category) return alert("Enter category");

    const text = await file.text();

    const res = await fetch(API + "/logs", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({
            logData: text,
            source,
            title,
            category
        })
    });

    if (!res.ok) alert("Upload failed");
    else {
        alert("Uploaded & analyzed");
        loadLogs();
    }
}


async function analyzePastedLog() {
    const text = document.getElementById("pasteArea").value.trim();
    const source = document.getElementById("pasteSource").value.trim();

    if (!text) return alert("Paste the log/error text first.");
    if (!source) return alert("Enter source.");

    setLoading(true, "Analyzing pasted log...");

    try {
        const res = await fetch(API + "/logs", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                logData: text,
                source: source,
    title: document.getElementById("pasteTitle").value.trim(),
    category: document.getElementById("pasteCategory").value.trim()
            })
        });

        if (!res.ok) alert("Failed to analyze log.");
        else {
            alert("Log analyzed!");
            await loadLogs();
        }

    } catch (e) {
        console.error(e);
        alert("Network error.");
    }

    setLoading(false);
}


async function openAIPanel(id) {
    document.getElementById("aiChatPanel").style.right = "0px";
    document.getElementById("aiChatOutput").innerHTML = "<b>Loading...</b>";

    try {
        const res = await fetch(API + `/logs/explain/${id}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        const text = await res.text();

        document.getElementById("aiChatOutput").innerHTML =
            "<b>Root Cause:</b>\n" + text +
            "\n\n<b>Ask me anything related to fixing this error â†’</b>";

        const log = allLogs.find(x => x.id === id);
        if (log) document.getElementById("aiLogTitle").innerText = log.title || "(No title)";

        window.currentLogId = id;
    } catch (e) {
        document.getElementById("aiChatOutput").innerText = "AI failed to analyze.";
    }
}


async function sendAIChat() {
    const q = document.getElementById("aiChatInput").value.trim();
    if (!q) return;

    const box = document.getElementById("aiChatOutput");
    box.innerHTML += `\n\n<b>You:</b> ${q}\n<b>AI:</b> Thinking...`;

    document.getElementById("aiChatInput").value = "";

    try {
        const res = await fetch(API + "/logs/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                logId: window.currentLogId,
                question: q
            })
        });

        const ai = await res.text();

        box.innerHTML = box.innerHTML.replace("Thinking...", ai);
        box.scrollTop = box.scrollHeight;

    } catch (e) {
        box.innerHTML += "\nAI error.";
    }
}
function closeAIPanel() {
    document.getElementById("aiChatPanel").style.right = "-420px";
}















</script>

</body>
</html>
