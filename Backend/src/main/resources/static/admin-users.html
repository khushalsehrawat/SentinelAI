<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management — AI SOC Platform</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #020d0a, #031510, #06261c);
            font-family: "Inter", sans-serif;
            color: white;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-size: 45px 45px;
            background-image:
                linear-gradient(to right, rgba(0,255,130,.08) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,255,130,.08) 1px, transparent 1px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
        }
        @keyframes gridMove {
            from { transform: translateY(0); }
            to   { transform: translateY(-50px); }
        }

        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            background: rgba(0,0,0,0.45);
            border-right: 1px solid rgba(0,255,120,0.25);
            backdrop-filter: blur(12px);
            padding-top: 40px;
        }
        .sidebar h3 {
            background: linear-gradient(135deg,#00ffc3,#00c27a);
            -webkit-background-clip: text;
            color: transparent;
        }
        .sidebar a {
            display: block;
            padding: 14px 22px;
            margin: 10px 0;
            color: #b7ffdd;
            text-decoration: none;
            font-weight: 500;
            border-radius: 8px;
            transition: .25s;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(0,255,150,0.20);
            color: #00ffb0;
            box-shadow: 0 0 18px rgba(0,255,150,.25);
        }

        .main {
            margin-left: 270px;
            padding: 40px 40px 70px;
        }

        .title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg,#00ffc3,#00c27a);
            -webkit-background-clip: text;
            color: transparent;
        }
        .sub {
            opacity: .8;
            margin-top: -4px;
        }

        .card-glass {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(0,255,140,0.25);
            border-radius: 18px;
            backdrop-filter: blur(14px);
            padding: 22px;
            margin-top: 24px;
        }

        .form-control,
        .form-select {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(0,255,130,0.25);
            color: #e9fff5;
        }
        .form-control:focus,
        .form-select:focus {
            border-color: #00ffb0;
            box-shadow: 0 0 10px #00ffb0;
        }

        .btn-cyber {
            background: linear-gradient(135deg,#00ffb0,#00c27a);
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            color: #03120c;
            font-weight: 700;
            transition: .25s;
        }
        .btn-cyber:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px #00ffb0;
        }

        .btn-lite {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(0,255,130,.3);
            background: rgba(255,255,255,0.06);
            color: #a6ffe2;
            font-size: .8rem;
        }
        .btn-lite:hover {
            background: rgba(0,255,130,.25);
            color: #02110c;
        }

        .role-pill {
            padding: 5px 12px;
            border-radius: 999px;
            font-size: .75rem;
            font-weight: 600;
            border: 1px solid rgba(0,255,130,.3);
            background: rgba(255,255,255,0.05);
        }
        .role-admin   { color:#ffb3b3; border-color:rgba(255,120,120,.6); }
        .role-analyst { color:#a8ffe0; }

        .table thead {
            background: linear-gradient(90deg,rgba(0,255,150,.22),rgba(0,120,80,.25));
        }
        .table thead th {
            border: none;
            color: #e2fff5;
            text-transform: uppercase;
            font-size: .8rem;
            letter-spacing: .06rem;
        }

        @media(max-width:768px){
            .sidebar{
                width:100%;
                height:auto;
                position:static;
                display:flex;
                flex-wrap:wrap;
                justify-content:center;
            }
            .main{
                margin-left:0;
                padding:25px 18px 60px;
            }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h3 class="text-center mb-4">AI SOC</h3>

    <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a href="logs.html"><i class="fas fa-file-alt"></i> Logs</a>
    <a href="incidents.html"><i class="fas fa-user-shield"></i> Incidents</a>
    <a href="alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="ip-lookup.html"><i class="fas fa-globe"></i> IP Lookup</a>
    <a href="admin-users.html" class="active"><i class="fas fa-users"></i> User Management</a>

    <a href="#" onclick="logout()" class="text-danger mt-2"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<!-- MAIN -->
<div class="main">

    <h2 class="title">User Management</h2>
    <p class="sub">Manage SOC users, roles, and access control for the AI Threat Detection Platform.</p>

    <!-- CREATE USER CARD -->
    <div class="card-glass">
        <h5 class="mb-3">Create New User</h5>
        <div id="createMsg" class="small mb-2" style="min-height:18px;"></div>

        <form id="userCreateForm" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Email</label>
                <input id="newEmail" type="email" class="form-control" placeholder="user@example.com" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Password</label>
                <input id="newPassword" type="password" class="form-control" placeholder="••••••••" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Role</label>
                <select id="newRole" class="form-select">
                    <option value="ADMIN">ADMIN</option>
                    <option value="ANALYST" selected>ANALYST</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn-cyber w-100" type="submit">Add</button>
            </div>
        </form>
    </div>

    <!-- USERS TABLE -->
    <div class="card-glass">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Existing Users</h5>
            <span class="small" style="opacity:.8;">Total: <span id="userCount">0</span></span>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th style="width:220px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <!-- rows via JS -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const API = "http://localhost:8080/api";
    const token = localStorage.getItem("jwt");

    if (!token) window.location.href = "login.html";

    function logout() {
        localStorage.removeItem("jwt");
        window.location.href = "login.html";
    }

    // Ensure only ADMIN can open this page
    (function checkAdmin(){
        try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            const roles = payload.roles || [];
            if (!roles.includes("ROLE_ADMIN")) {
                alert("Only ADMIN can access User Management.");
                window.location.href = "dashboard.html";
            }
        } catch(e) {
            console.error(e);
            window.location.href = "login.html";
        }
    })();

    let users = [];

    async function loadUsers() {
        // expected backend endpoint: GET /admin/users
        const res = await fetch(API + "/users", {
            headers: {"Authorization":"Bearer " + token}
        });

        if (!res.ok) {
            alert("Failed to load users.");
            return;
        }

        users = await res.json();
        renderUsers();
    }

    function renderUsers() {
        const body = document.getElementById("usersBody");
        const count = document.getElementById("userCount");
        body.innerHTML = "";
        count.innerText = users.length;

        if (!users.length) {
            body.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No users found.</td></tr>`;
            return;
        }

        users.forEach((u, idx) => {
            const tr = document.createElement("tr");
            const role = (u.role || "").toUpperCase();
            const roleClass = role === "ADMIN" ? "role-admin" : "role-analyst";
            tr.innerHTML = `
                <td>${idx+1}</td>
                <td>${u.email}</td>
                <td>
                    <span class="role-pill ${roleClass}">${role}</span>
                </td>
                <td>${u.createdAt || "-"}</td>
                <td>
                    <select class="form-select form-select-sm d-inline-block w-auto me-1" data-userid="${u.id}" onchange="onRoleChange(this)">
                        <option value="ADMIN" ${role==="ADMIN"?"selected":""}>ADMIN</option>
                        <option value="ANALYST" ${role==="ANALYST"?"selected":""}>ANALYST</option>
                    </select>
                    <button class="btn-lite me-1" onclick="resetPassword(${u.id})">Reset Pw</button>
                    <button class="btn-lite text-danger" onclick="deleteUser(${u.id})">Delete</button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    // CREATE USER (uses same /auth/register as register page)
    document.getElementById("userCreateForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("createMsg");
        msg.style.color = "#9effd6";
        msg.innerText = "Creating user...";

        try {
            const res = await fetch(API + "/auth/register", {
                method: "POST",
                headers: {
                    "Content-Type":"application/json",
                    "Authorization":"Bearer " + token
                },
                body: JSON.stringify({
                    email: newEmail.value.trim(),
                    password: newPassword.value.trim(),
                    role: newRole.value
                })
            });

            if (!res.ok) {
                msg.style.color = "#ff9f9f";
                msg.innerText = "Failed — maybe email already exists.";
                return;
            }

            msg.style.color = "#9effd6";
            msg.innerText = "User created successfully.";
            newEmail.value = "";
            newPassword.value = "";
            newRole.value = "ANALYST";

            await loadUsers();

        } catch (err) {
            console.error(err);
            msg.style.color = "#ff9f9f";
            msg.innerText = "Network error.";
        }
    });

    // ROLE CHANGE
    async function onRoleChange(selectEl) {
        const userId = selectEl.getAttribute("data-userid");
        const newRole = selectEl.value;

        // expected backend: PUT /admin/users/{id}/role {role:"ADMIN"/"ANALYST"}
        try {
            const res = await fetch(API + "/admin/users/" + userId + "/role", {
                method: "PUT",
                headers: {
                    "Content-Type":"application/json",
                    "Authorization":"Bearer " + token
                },
                body: JSON.stringify({ role: newRole })
            });

            if (!res.ok) {
                alert("Failed to update role.");
                await loadUsers();
                return;
            }
            await loadUsers();
        } catch (err) {
            console.error(err);
            alert("Network error.");
        }
    }

    // RESET PASSWORD
    async function resetPassword(userId) {
        const newPw = prompt("Enter new password for this user:");
        if (!newPw) return;

        // expected backend: PUT /admin/users/{id}/reset-password {newPassword:"..."}
        try {
            const res = await fetch(API + "/admin/users/" + userId + "/reset-password", {
                method: "PUT",
                headers: {
                    "Content-Type":"application/json",
                    "Authorization":"Bearer " + token
                },
                body: JSON.stringify({ newPassword: newPw })
            });

            if (!res.ok) {
                alert("Failed to reset password.");
                return;
            }
            alert("Password reset successfully.");
        } catch (err) {
            console.error(err);
            alert("Network error.");
        }
    }

    // DELETE USER
    async function deleteUser(userId) {
        if (!confirm("Delete this user permanently?")) return;

        // expected backend: DELETE /admin/users/{id}
        try {
            const res = await fetch(API + "/admin/users/" + userId, {
                method: "DELETE",
                headers: { "Authorization":"Bearer " + token }
            });

            if (!res.ok) {
                alert("Failed to delete user.");
                return;
            }
            await loadUsers();
        } catch (err) {
            console.error(err);
            alert("Network error.");
        }
    }

    loadUsers();
</script>
</body>
</html>
